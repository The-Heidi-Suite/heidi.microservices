// Prisma schema for Core microservice
// Contains: SystemConfig, Permissions, Listings
generator client {
  provider = "prisma-client-js"
  output   = "../../../../node_modules/.prisma/client-core"
}

datasource db {
  provider = "postgresql"
  url      = env("CORE_DATABASE_URL")
}

// SystemConfig - System-wide configuration
model SystemConfig {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String
  category  String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@index([isActive])
  @@map("system_configs")
}

// Permission model - Defines available permissions
model Permission {
  id          String   @id @default(uuid())
  resource    String   // e.g., "users", "cities", "notifications"
  action      String   // e.g., "read", "write", "delete"
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  rolePermissions RolePermission[]

  @@unique([resource, action])
  @@index([resource])
  @@index([action])
  @@map("permissions")
}

// RolePermission - Maps roles to permissions
model RolePermission {
  id           String     @id @default(uuid())
  role         UserRole
  permissionId String
  createdAt    DateTime   @default(now())

  // Relations
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([role, permissionId])
  @@index([role])
  @@index([permissionId])
  @@map("role_permissions")
}

// UserCityAssignment - Links users to cities with specific roles
// Note: userId and cityId are stored as strings (no FK due to multi-database architecture)
model UserCityAssignment {
  id             String   @id @default(uuid())
  userId         String   // Reference to User.id in users database
  cityId         String   // Reference to City.id in city database
  role           UserRole
  canManageAdmins Boolean  @default(false)
  assignedBy     String?  // Reference to User.id who created this assignment
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([userId, cityId])
  @@index([userId])
  @@index([cityId])
  @@index([role])
  @@index([isActive])
  @@index([canManageAdmins])
  @@index([assignedBy])
  @@map("user_city_assignments")
}

// Listing model - Content/listings created by citizens and moderated by city admins
// Note: userId and cityId are stored as strings (no FK due to multi-database architecture)
model Listing {
  id         String       @id @default(uuid())
  userId     String       // Reference to User.id in users database (creator)
  cityId     String       // Reference to City.id in city database
  title      String
  content    String
  status     ListingStatus @default(PENDING)
  category   String?
  metadata   Json?
  reviewedBy String?      // Reference to User.id who reviewed (city admin)
  reviewedAt DateTime?
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt

  @@index([userId])
  @@index([cityId])
  @@index([status])
  @@index([createdAt])
  @@index([category])
  @@map("listings")
}

enum UserRole {
  SUPER_ADMIN
  CITY_ADMIN
  CITIZEN
}

enum ListingStatus {
  PENDING      // Awaiting moderation
  APPROVED     // Approved by city admin
  REJECTED     // Rejected by city admin
  DELETED      // Soft deleted
}
