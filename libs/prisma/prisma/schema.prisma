// Prisma schema for HEIDI microservices
generator client {
  provider = "prisma-client-js"
  output   = "../../../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model - for authentication and user management
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  role      UserRole @default(USER)
  firstName String?
  lastName  String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  // Relations
  notifications Notification[]
  integrations  Integration[]

  @@index([email])
  @@index([isActive])
  @@map("users")
}

enum UserRole {
  USER
  ADMIN
  MODERATOR
}

// City model - for geographic data management
model City {
  id          String   @id @default(uuid())
  name        String
  country     String
  state       String?
  latitude    Float
  longitude   Float
  population  Int?
  timezone    String?
  metadata    Json?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([name, country, state])
  @@index([country])
  @@index([latitude, longitude])
  @@map("cities")
}

// Notification model - for multi-channel notifications
model Notification {
  id        String             @id @default(uuid())
  userId    String
  type      NotificationType
  channel   NotificationChannel
  subject   String?
  content   String
  metadata  Json?
  status    NotificationStatus @default(PENDING)
  sentAt    DateTime?
  readAt    DateTime?
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("notifications")
}

enum NotificationType {
  INFO
  WARNING
  ERROR
  SUCCESS
  ALERT
}

enum NotificationChannel {
  EMAIL
  SMS
  PUSH
  IN_APP
}

enum NotificationStatus {
  PENDING
  SENT
  FAILED
  DELIVERED
  READ
}

// Schedule model - for cron jobs and scheduled tasks
model Schedule {
  id             String    @id @default(uuid())
  name           String
  description    String?
  cronExpression String
  payload        Json?
  isEnabled      Boolean   @default(true)
  lastRun        DateTime?
  lastRunStatus  String?
  nextRun        DateTime?
  runCount       Int       @default(0)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([isEnabled])
  @@index([nextRun])
  @@map("schedules")
}

// Integration model - for external service integrations
model Integration {
  id          String            @id @default(uuid())
  userId      String
  provider    IntegrationProvider
  name        String
  credentials Json? // Encrypted credentials
  webhookUrl  String?
  config      Json?
  isActive    Boolean           @default(true)
  lastSyncAt  DateTime?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  logs IntegrationLog[]

  @@index([userId])
  @@index([provider])
  @@index([isActive])
  @@map("integrations")
}

enum IntegrationProvider {
  STRIPE
  SENDGRID
  TWILIO
  SLACK
  WEBHOOK
  CUSTOM
}

// Integration logs - for tracking integration activity
model IntegrationLog {
  id            String   @id @default(uuid())
  integrationId String
  event         String
  payload       Json?
  response      Json?
  status        String
  errorMessage  String?
  createdAt     DateTime @default(now())

  // Relations
  integration Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  @@index([integrationId])
  @@index([createdAt])
  @@map("integration_logs")
}
